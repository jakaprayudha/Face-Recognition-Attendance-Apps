<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>Absensi Wajah</title>
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
  <style>
    body { background-color: #f8f9fa; }
    .video-container { text-align: center; margin-top: 20px; }
    img { border-radius: 15px; box-shadow: 0 4px 10px rgba(0,0,0,0.2); }
    .toast-container { position: fixed; top: 1rem; right: 1rem; z-index: 1055; }
  </style>
</head>
<body>
<div class="container text-center mt-3">
  <h2>Absensi Wajah</h2>
  <div class="video-container">
    <img src="{{ url_for('video_feed') }}" width="640" height="480">
  </div>
  <div class="mt-3">
    <input type="text" id="nama" value="{{ username }}" class="form-control w-50 mx-auto" placeholder="Masukkan Nama" />
    <button id="btnCheckIn" class="btn btn-success mt-3">Mulai Check In</button>
    <br>
    <a href="/map" class="btn btn-info mt-2">📍 Lihat Peta Kehadiran</a>
    <br>
    <div class="text-end">
  <a href="/logout" class="btn btn-danger btn-sm">Logout</a>
</div>
  </div>
</div>

<!-- Toasts -->
<div class="toast-container">
  <div id="toast-success" class="toast text-bg-success border-0">
    <div class="toast-body">✅ Absensi Berhasil Disimpan!</div>
  </div>
  <div id="toast-error" class="toast text-bg-danger border-0">
    <div class="toast-body">❌ Gagal Menyimpan Absensi!</div>
  </div>
</div>

<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
<script>
const toastSuccess = new bootstrap.Toast(document.getElementById("toast-success"));
const toastError = new bootstrap.Toast(document.getElementById("toast-error"));

let recognized = false;

// Cek status wajah setiap 2 detik
setInterval(() => {
  fetch("/status")
    .then(res => res.json())
    .then(data => {
      recognized = data.recognized;
    });
}, 2000);

// Tombol Check In
document.getElementById("btnCheckIn").addEventListener("click", () => {
  if (!recognized) {
    alert("Wajah belum dikenali! Pastikan wajah kamu terdeteksi dengan benar.");
    return;
  }

  // Ambil lokasi GPS
  if (navigator.geolocation) {
    navigator.geolocation.getCurrentPosition((pos) => {
      const nama = document.getElementById("nama").value || "Unknown";
      const data = {
        nama: nama,
        latitude: pos.coords.latitude,
        longitude: pos.coords.longitude
      };

      fetch("/checkin", {
        method: "POST",
        headers: { "Content-Type": "application/json" },
        body: JSON.stringify(data)
      })
      .then(res => res.json())
      .then(resp => {
        if (resp.status === "success") toastSuccess.show();
        else toastError.show();
      });
    }, () => alert("Gagal mendapatkan lokasi."));
  } else {
    alert("Browser tidak mendukung geolokasi.");
  }
});
</script>
</body>
</html>